<!doctype html>
<html>
	<head>
		
		<title>Phylogenetics using Variational Inference</title>
	
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
	
		<link rel="stylesheet" href="theme.css" id="theme">

		<!-- Printing and PDF exports -->
<!-- 
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
 -->
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h3 class="title">Phylogenetics using Variational Inference</h3>
<br>
                    Mathieu&nbsp;Fourment
<br>
<br>
                    <div class="institution">ithree institute<br>
                    University of Technology Sydney</div>

<!-- 
                    <div class="date">9<sup>th</sup> Phylomania Meeting<br>
                        6-8 December, 2017</div>
 -->
                </section>
                
                <section>
                	<h3>Approximating Distributions in Phylogenetics</h3>
                	<ul>
                		<li>Usually approximate posterior with MCMC and propose parameters one by one</li>
                		<li>Approximate distribution of one branch length using a parametric distribution (<i>Aberer et al. 2016</i>)</li>
                		<li>Approximate distribution of one branch length using specialised surrogate function (<i>Claywell et al. 2017</i>)</li>
						<li>Adaptive MCMC to jointly propose parameters (<i>Baele et al. 2017</i>)</li>
                	</ul>
                </section>
                
                <section>
                	<h3>Approximating the distribution of one branch length</h3>
					<ul>
                		<li>Fitting parametric distribution</li>
                		<li>Goal is to improve sampling the tree space using an independence sampler</li>
                	</ul>
					<div class="figure" style="float:left;width:90%">
                		<img style="width:400px" data-src="aberer.png"/>
                	</div>
                	<div style="float:right;width:10%">
                		<p style="font-size:15px;position: absolute;
  bottom: 0;
  right: 0;">Aberer, Stamatakis, Ronquist. Syst Biol 2016</p>
                	</div>
                </section>
                
                <section>
                	<h3>Approximating the distribution of a branch length</h3>
					<ul>
                		<li>Fitting a simpler distribution:</li>
                		<li>$$ f(c, m, r, b; t) = c \log \left ( \frac{1 + e^{(r(t + b))^{-1}}}{2} \right ) + m \log \left(\frac{1 - e^{(r(t + b))^{-1}}}{2} \right) $$</li>
                		<li>Parameters: c (# constant sites), m (# mutated sites), r (rate), b (truncation)</li>
                		<li>Nonlinear least-squares optimization</li>
                		<li>Sampling from surrogate function using rejection sampling</li>
                		<li>Improved the efficiency of SMC sampler (see poster)</li>
                	</ul> 
<!--                	<img style="width:800px" data-src="aberer.png"/> -->
                 	<p style="font-size:15px">Claywell, Dinh, Fourment, McCoy, Matsen. MBE 2017</p>
                 	<p style="font-size:15px">Fourment, Claywell, Dinh, McCoy, Matsen, Darling. Syst Biol 2017</p>
 
                </section>
                
                <section>
					<h3>Variational inference</h3>
					<p>Minimize the Kullback Leibler divergence from variational distribution $q$ to posterior distribution $p$</p>
					$$ \boldsymbol{\phi}^* = \operatorname*{arg\,min}_{\boldsymbol{\phi} \in \boldsymbol{\Phi}}  \operatorname{KL}(q(\boldsymbol{\theta}; \boldsymbol{\phi}) \parallel p(\boldsymbol{\theta} \mid \mathbf{x})) $$
					<p style="font-size:15px">Review: Blei, Kucukelbir, McAuliffe 2016</p>
				</section>
				
				<section>
					<h3>Evidence lower bound (ELBO)</h3>
					\[ \begin{aligned} \operatorname{KL}(q(\boldsymbol{\theta}; \boldsymbol{\phi}) \parallel p(\boldsymbol{\theta} \mid \mathbf{x})) &amp; = \mathop{\mathbb{E}}[\log q(\boldsymbol{\theta})] - \mathop{\mathbb{E}}[\log p(\boldsymbol{\theta} \mid \mathbf{x})] \\
					&amp; = \mathop{\mathbb{E}}[\log q(\boldsymbol{\theta})] - \mathop{\mathbb{E}}[\log p(\boldsymbol{\theta}, \mathbf{x})] + \log p(\mathbf{x})
					 \end{aligned}\]
					 <div class="fragment">
					 	<p>$p(\mathbf{x})$ constant with respect to $q(\boldsymbol{\theta})$</p>
					 </div>
					 <div class="fragment">
					<p>Instead of minimizing KL divergence, maximize evidence lower bound:</p>
					
					$$ \textrm{ELBO}(q) = \mathop{\mathbb{E}}_{q(\boldsymbol{\theta}; \boldsymbol{\phi})}[\log p(\mathbf{x}, \boldsymbol{\theta}) - \log q(\boldsymbol{\theta}; \boldsymbol{\phi})]$$
					</div>
					<div class="fragment">
					<p>ELBO(q) is the lower bound of evidence:</p>
						$$\log p(\mathbf{x}) \geq \textrm{ELBO}(q)$$
					</div>
				</section>
				
				<section>
					<h3>Variational distributions</h3>
					<div class="fragment">
						<p>Mean-field Gaussian:</p>
						$$ q(\boldsymbol{\theta}; \boldsymbol{\phi}) = \mathcal{N}(\boldsymbol{\theta}; \boldsymbol{\mu}, diag(\boldsymbol{\sigma}^2)) = \prod_{i=1}^n \mathcal{N}(\theta_i; \mu_i, \sigma_i^2) $$
					</div>
					<div class="fragment">
						<p>Full-rank Gaussian:</p>
						$$ q(\boldsymbol{\theta}; \boldsymbol{\phi}) = \mathcal{N}(\boldsymbol{\theta}; \boldsymbol{\mu}, \boldsymbol{\Sigma}) $$
					</div>
				</section>
				
				<section>
					<h3>Algorithm</h3>
					<ul>
						<li>Stochastic gradient ascent to optimize the ELBO</li>
						<li>Requires calculating gradient of probability models</li>
						<li>Transformation of constrained variables (e.g. branch length lives in $\mathbb{R}^+$)</li>
					</ul>
				</section>
				
				<section>
					<h3> Variational inference software</h3>
					Require calculating derivatives (automatic differentiation)
					<ul>
						<li>Stan (HMC, MCMC)</li>
						<li>Edward, BayesPi, PyMC3, Pyro (Uber) ...</li>
					</ul>
				</section>
				
				<section>
					<h3>Simple Stan model</h3>
					<img style="width:800px" data-src="stan.png"/>
				</section>
				
				<section>
<!-- 					<h3 style="font-size:15px">Jukes Cantor model in Stan</h3> -->
					<img style="height:70%; width:70%" data-src="jc69.png"/>
				</section>
				
				<section>
					<h3>Simulation study</h3>
					<div class="figure" style="float:left;width:50%">
                		<ul>
						<li>Random coalescent tree with 6 taxa</li>
						<li>Simulate alignment with GTR</li>
						<li>Every ranked labelled tree was enumerated (2700 topologies)</li>
						<li>Analyse with BEAST and Stan</li>
					</ul>
                	</div>
                	<div style="float:right;width:50%">
						<img style="width:800px;;" data-src="simtree.png"/>
                	</div>
				</section>
				
				<section>
					<h3>Estimates using true tree</h3>
					<img style="width:500px;" data-src="estimates-true-tree.svg"/>
				</section>
				
				<section>
					<h3>Marginal likelihood vs. ELBO</h3>
					<div class="figure" style="float:left;width:50%">
					<ul>
						<li>Marginal likelihood calculated using path sampling</li>
						<li>Stochastic gradient ascent trapped in local maxima</li>
					</ul>
					</div>
					<div class="figure" style="float:right;width:50%">
					<img style="width:500px;" data-src="elbo-marginal.svg"/>
					</div>
				</section>
				
				<section>
					<h3>Marginal likelihood vs. ELBO</h3>
					<div class="figure" style="float:left;width:50%">
					<ul>
						<li>Rerun Stan several times and chose the highest ELBO</li>
						<li>Slope: 0.99 Intercept: -11.9</li>
					</ul>
					</div>
					<div class="figure" style="float:right;width:50%">
						<img style="width:500px;" data-src="elbo-marginal-clean.svg"/>
					</div>
				</section>
				
				<section>
					<h3>Parameter correlation from MCMC output</h3>
					<div class="figure" style="float:left;width:50%">
					<ul>
						<li>Heatmap representing correlation matrix (Red=positive, blue: negative correlation )</li>
						<li>Strong correlation between some parameters (e.g. adjacent branches)</li>
						<li>Mean-field variational model ignores correlation between model parameters</li>
					</ul>
					</div>
					<div class="figure" style="float:right;width:50%">
						<img style="width:500px;" data-src="heatmap.mcmc.true-tree.svg"/>
					</div>
				</section>
				
				<section>
					<h3>Correlation in a larger tree</h3>
					<img style="width:500px;" data-src="heatmap.fluA.svg"/>
				</section>
				
				<section>
					<h3>Parameter correlation with variational model</h3>
					<img style="width:300px;" data-src="heatmap.mcmc.true-tree.svg"/>
					<img style="width:300px;" data-src="heatmap.vb.mf.true-tree.svg"/>
					<img style="width:300px;" data-src="heatmap.vb.fullrank.true-tree.svg"/>
				</section>
				
				<section>
					<h3>Problems and  ideas</h3>
					<ul>
						<li>Short branches are difficult to approximate. Problem also encountered in surrogate and parametric approximations of a single branch</li>
						<li>Reducing the number parameters</li>
						<li>Setting covariances to 0: we should expect low or no correlation between branches that are far apart</li>
					</ul>
				</section>
				
				<section>
					<h3>Summary</h3>
					<ul>
						<li>Testing sparse covariance matrix for full-rank model</li>
						<li>Not possible in Stan, working on a specialised phylogenetic variational program</li>
						<li>Combining multiple trees</li>
						<li>Investigate other divergence measures (lower and upper bound of marginal likelihood)</li>
					</ul>
				</section>
				
				<section>
					<h3>Acknowledgements</h3>
					<br>
					<ul>
						<li>Aaron Darling, University of Technology Sydney<br><br></li>
						<li>Erick Matsen, Fred Hutchinson Cancer Research<br><br></li>
						<li>The following organizations:<br><br>
							<div style="text-align:center">
								<img data-src="ausgem.png" style="box-shadow:none;height:80px">
								<img data-src="uts.svg" style="border:none;box-shadow:none;background-color:#002b36;height:80px">
							</div>
						</li>
        			</ul>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
// 			Reveal.configure({ slideNumber: true });
			Reveal.initialize({
			slideNumber: 'c/t',
				progress: true,
				math: {
                    mathjax: 'https://cdn.mathjax.org/mathjax/latest/MathJax.js',
                    config: 'TeX-AMS_HTML-full'  // See http://docs.mathjax.org/en/latest/config-files.html
                },
				dependencies: [
					{ src: 'plugin/math/math.js', async: true },
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
